@using System.Net.Http

@inject HttpClient client

<meta charset="utf-8" />
<base href="/" />

@if (FaviconIsSvg)
{
    <link rel="icon" type="image/svg" sizes="32x32" href="/meta/favicon.svg?dark" media="(prefers-color-scheme: dark)" />
    <link rel="icon" type="image/svg" sizes="32x32" href="/meta/favicon.svg?light" media="(prefers-color-scheme: light)" />
}
else
{
    <link rel="icon" type="image/png" sizes="512x512" href="/meta/favicon.png" />
}
<link rel="manifest" href="/pwa/site.webmanifest" />

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
@if (string.IsNullOrWhiteSpace(Cdn) == false)
{
    <link rel="stylesheet" type="text/css" href="https://cdn.conesoft.net/@(Cdn).css?v=@CdnStyleMinVersion" />
}
<link rel="stylesheet" type="text/css" href="@(AppDomain.CurrentDomain.FriendlyName).styles.css?v=@ScopedStyleVersion" />

@if(ForceRefresh)
{
    <style>html { background: black !important; color: black !important; } html * { display: none !important }</style>
    <meta http-equiv="refresh" content="0" />
}

@code {
    string CdnStyleMinVersion = "";
    string ScopedStyleVersion = "";

    bool FaviconIsSvg = false;
    bool ForceRefresh = false;


    [Parameter]
    public string Cdn { get; set; } = "style";

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(Cdn) == false)
        {
            try
            {
                var cts = new CancellationTokenSource(100);
                CdnStyleMinVersion = (await client.GetStringAsync($"https://cdn.conesoft.net/{Cdn}.min.css.md5", cts.Token)).TrimEnd();
            }
            catch
            {
                ForceRefresh = true;
            }
        }
        if (File.Exists($"wwwroot/{AppDomain.CurrentDomain.FriendlyName}.styles.css"))
        {
            ScopedStyleVersion = new FileInfo($"wwwroot/{AppDomain.CurrentDomain.FriendlyName}.styles.css").LastWriteTimeUtc.Ticks.ToString();
        }
        else
        {
            ScopedStyleVersion = Random.Shared.Next().ToString();
        }
        FaviconIsSvg = File.Exists($"wwwroot/icons/favicon.svg");
    }
}